# The workflow to test the 
name:  React.js Main -Development

on:
    push:
        branches: [main]

jobs:
    # BUILD THE REACT APPLICATION
    build_test:
        name: Test the Main branch of {React App}
        runs-on: ubuntu-latest
        environment: dev

        steps:

        # Checkout Github Repo
        -   name: 'Checkout GitHub Action'
            uses: actions/checkout@v3                
                
        # Setup Node Environment
        -   name: Setup Node ${{ env.NODE_VERSION }} Environment
            uses: actions/setup-node@v3
            with: 
                node-version: ${{ env.NODE_VERSION }}
        
        # install applicaion dependencies
        -   name: 'Install Dependencies'
            run: |
                npm install
        # # build and test the apps
        # -   name: 'Build React App'
        #     run: |
        #         npm run build
        #         npm test

        
    
    # PUSH TO DOCKER REPOSITORY
    push_to_docker:
        name: Push to Docker Hub
        runs-on: ubuntu-latest
        needs: [build_test]

        steps:
        
        # Setup Docker Quick EMUlator
        -   name: Setup QEMU
            uses: docker/setup-qemu-action@v2
        
        # Setup Docker Buildx
        -   name: Setup Docker Buildx
            uses: docker/setup-buildx-action@v2
        
        # Login with Docker
        -   name: Login to Docker
            uses: docker/login-action@v1
            with:
                username: ${{ secrets.DOCKER_REACT_USERNAME }}
                password: ${{ secrets.DOCKER_ACCESS_TOKEN }}
        
        # Checkout Github Repo
        -   name: Checkout
            uses: actions/checkout@v2
        
        # -   name: Build Docker image
        #     run: |
        #         ls
        #         docker build . -t ${{ secrets.DOCKER_REACT_USERNAME }}/hello-lantern:latest -f ./Dockerfile
        
 
        # Docker Build and Push the Commit to Docker Hub
        # -   name: Docker Build and Push
        #     uses: docker/build-push-action@v4
        #     with:
        #         context: .
        #         file: ./Dockerfile
        #         push: true
        #         tags:  ${{ secrets.DOCKER_REACT_USERNAME }}/hello-lantern:latest

        # # Run the Container 
        # -   name: Run the image in a container
        #     uses: addnab/docker-run-action@v3
        #     with:
        #         image: ${{ secrets.DOCKER_REACT_USERNAME }}/hello-lantern:latest
        #         options: '--name First_App -d -p 80:3000'
                
    echo:
        name: Azure Deployment
        runs-on: ubuntu-latest
        needs: [push_to_docker]
        environment: dev
        env:
            ENV_VAR_1: ${{ secrets.ENV_VAR_1 }}
            ENV_VAR_2: ${{ secrets.ENV_VAR_2 }}
        steps:
        -   name: "Testing creation of ENV"
            run: |
                n=2
                concatenated_values=""
                for ((i=1; i<=n; i++)); do
                    var_name = "ENV_VAR_${i}"
                    env_var_value=${!var_name}
                    concatenated_values="$concatenated_values $env_var_value"
                done

                echo "Concatenated Env Values = $concatenated_values"


    azure_deployment:
        name: Azure Deployment
        runs-on: ubuntu-latest
        needs: [push_to_docker]
        environment: dev
        steps:
        -   name: 'Login via Azure CLI'
            uses: azure/login@v1
            with:
                creds: ${{ secrets.AZURE_CREDENTIALS }}
        
        -   name: 'Azure Key Vault Creds'
            uses: Azure/get-keyvault-secrets@v1
            with:
                keyvault: "lantern-demo"
                secrets: 'DOCKER-ACCESS-TOKEN, DOCKER-REACT-USERNAME, REACT-APP-COMPANY-NAME, REACT-APP-USERNAME'
            id: keyVaultSecrets

        # -   name: "Echo The Secrets"
        #     run: |
        #         echo "${{ steps.keyVaultSecrets.outputs.DOCKER-REACT-USERNAME }}"
        #         echo "${{ steps.keyVaultSecrets.outputs.REACT-APP-COMPANY-NAME}}"
        #         echo "${{ steps.keyVaultSecrets.outputs.REACT-APP-USERNAME }}"
        
        -   name: Deploy to Azure Container Apps
            uses: azure/container-apps-deploy-action@v1
            with:
                registryUrl: registry.hub.docker.com
                registryUsername: ${{ steps.keyVaultSecrets.outputs.DOCKER-REACT-USERNAME }}
                registryPassword: ${{ steps.keyVaultSecrets.outputs.DOCKER-ACCESS-TOKEN }}
                imageToDeploy: ${{ secrets.DOCKER_REACT_USERNAME }}/hello-lantern:latest
                targetPort: 3000
                resourceGroup: lanterndemo
                containerAppName: hello-lantern    
                environmentVariables: REACT_APP_COMPANY_NAME="${{steps.keyVaultSecrets.outputs.REACT-APP-COMPANY-NAME}}"
                    REACT_APP_USERNAME="${{steps.keyVaultSecrets.outputs.REACT-APP-USERNAME}}"
                
                
        -   name: "Azure logout"
            run: |
                az logout


        
        